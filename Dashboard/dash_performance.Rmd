---
title: "<center><div class='mytitle'> MY PORTFOLIO PERFORMANCE ANALYSIS</div></center>"
date: <center>'`r format(Sys.time(), "%d %B, %Y")`'</center>
css: style.css
output: 
  html_document:
   #  toc: FALSE
   includes:
    before_body: header.html
    after_body: footer.html
---

```{r echo=T, results='hide', echo=FALSE}
setwd(here::here())
suppressMessages(source('profileRep.R'))
load("Data/Portfolio_Market.RData")
```

```{r include = TRUE, echo=FALSE}
dp$position %>% subset(!(Category=='Benchmark') & (dp$risk$SharePortfolio>0.0001) ,
                       select=c('Category',
                                'SharePortfolio', 
                                'Value',
                                '1D.return',
                                "1D.logReturn",
                                "5D.logReturn",
                                "23D.logReturn",
                                "125D.logReturn",
                                "250D.logReturn")) %>% 
  mutate(L1Value=Value / (1 +`1D.logReturn`),
         L5Value=Value / (1 +`5D.logReturn`),
         `5D.return`= L5Value * `5D.logReturn`,
         L23Value=Value / (1 +`23D.logReturn`),
         `23D.return`= L23Value * `23D.logReturn`,
         L125Value=Value / (1 +`125D.logReturn`),
         `125D.return`= L125Value * `125D.logReturn`,
         L250Value=Value / (1 +`250D.logReturn`),
         `250D.return`= L250Value * `250D.logReturn`) %>%
  group_by(Category) %>% 
  summarize(
    Value=round(sum(Value),0),
    SharePortfolio = sum(SharePortfolio),
    `1D.return`=round(sum(`1D.return`),0),
    `1D.logReturn`= sum(`1D.return`),
    `L1Value`= sum(L1Value),
    `5D.logReturn`= sum(`5D.return`),
    `L5Value`= sum(L5Value),
    `23D.logReturn`= sum(`23D.return`),
    `L23Value`= sum(L23Value),
    `125D.logReturn`= sum(`125D.return`),
    `L125Value`= sum(L125Value),
    `250D.logReturn`= sum(`250D.return`),
    `L250Value`= sum(L250Value)
  ) %>%
  mutate(`1D.logReturn`=`1D.logReturn`/`L1Value`)%>%
  mutate(`5D.logReturn`=`5D.logReturn`/`L5Value`)%>%
  mutate(`23D.logReturn`=`23D.logReturn`/`L23Value`)%>%
  mutate(`125D.logReturn`=`125D.logReturn`/`L125Value`)%>%
  mutate(`250D.logReturn`=`250D.logReturn`/`L250Value`)%>%
  dplyr::rename(D1.LR = `1D.logReturn`,
                D5.LR = `5D.logReturn`,
                D23.LR = `23D.logReturn`,
                D125.LR = `125D.logReturn`,
                D250.LR = `250D.logReturn`) %>%
  select(-c(L1Value,L5Value,L23Value,L125Value,L250Value)) -> t2

t2%>%
  datatable(extensions = 'Buttons', options = list(pageLength = 100,
    dom = 'Bfrtip',
    buttons = list('copy', 'csv', 'excel', 'pdf', 'print',
    list(extend = 'colvis',visible=F, targets= 0, columns = c(3:dim(t2)[2])))
        ))%>%
  formatCurrency('Value', '\U20AC', digits = 0) %>%
    formatCurrency('1D.return', '\U20AC', digits = 0) %>%
  formatPercentage('D1.LR', 2) %>%
  formatStyle('D1.LR', background = color_from_middle(t2$D1.LR,'pink','lightgreen'))%>%
formatPercentage('D5.LR', 2) %>%
  formatStyle('D5.LR', background = color_from_middle(t2$D5.LR,'pink','lightgreen'))%>%
  formatPercentage('D23.LR', 2) %>%
  formatStyle('D23.LR', background = color_from_middle(t2$D23.LR,'pink','lightgreen'))%>%
  formatPercentage('D125.LR', 2) %>%
  formatStyle('D125.LR', background = color_from_middle(t2$D125.LR,'pink','lightgreen'))%>%
  formatPercentage('D250.LR', 2) %>%
  formatStyle('D250.LR', background = color_from_middle(t2$D250.LR,'pink','lightgreen'))%>%
  formatPercentage('SharePortfolio', 1) %>%
  formatStyle('SharePortfolio', background = color_from_middle(t2$SharePortfolio,'lightblue','lightblue'))
```


# Performance Overview Open Positions:

```{r include = TRUE, echo=FALSE}
dp$position <-  replace(dp$position, is.na(dp$position),0)
dp$position %>% subset((dp$position$SharePortfolio>0.001 &
                          !is.na(dp$position$SharePortfolio)) | dp$position$Name == 'Portfolio:'| 
                         dp$position$Category == 'Benchmark', 
                       select=c("Category",'Name',
                                'CloseDate','Value','Volume',
                                'SharePortfolio',
                                "1D.logReturn",
                                "CAPM.Return",
                                "1D.return",
                                "5D.logReturn",
                                "23D.logReturn",
                                "125D.logReturn",
                                "250D.logReturn")) %>% 
  dplyr::rename('D1.LR'='1D.logReturn')%>%
  dplyr::rename('CAPM.Return'='CAPM.Return')%>%
  dplyr::rename('D1.R'='1D.return')%>%
  dplyr::rename('D5.LR'='5D.logReturn')%>%
  dplyr::rename('D23.LR'='23D.logReturn')%>%
  dplyr::rename('D125.LR'='125D.logReturn')%>%
  dplyr::rename('D250.LR'='250D.logReturn')%>%
  dplyr::mutate(Value=round(`Value`,0))%>%
  plyr::arrange(Category,!SharePortfolio) -> t2

  t2 %>%
    datatable(extensions = 'Buttons', options = list(pageLength = 100,
    dom = 'Bfrtip',
    buttons = list('copy', 'csv', 'excel', 'pdf', 'print',
    list(extend = 'colvis',visible=F, targets= 0, columns = c(3:dim(t2)[2])))
        )) %>%
  formatCurrency('D1.R', '\U20AC', digits = 1) %>%
  formatCurrency('Value', '\U20AC', digits = ) %>%
  formatPercentage('D1.LR', 2) %>%
  formatStyle('D1.LR', background = color_from_middle(t2$D1.LR,'pink','lightgreen'))%>%
  formatPercentage('CAPM.Return', 2) %>%
  formatStyle('CAPM.Return', background = color_from_middle(t2$CAPM.Return,'pink','lightgreen'))%>%
  formatPercentage('D5.LR', 2) %>%
  formatStyle('D5.LR', background = color_from_middle(t2$D5.LR,'pink','lightgreen'))%>%
  formatPercentage('D23.LR', 2) %>%
  formatStyle('D23.LR', background = color_from_middle(t2$D23.LR,'pink','lightgreen'))%>%
  formatPercentage('D125.LR', 2) %>%
  formatStyle('D125.LR', background = color_from_middle(t2$D125.LR,'pink','lightgreen'))%>%
  formatPercentage('D250.LR', 2) %>%
  formatStyle('D250.LR', background = color_from_middle(t2$D250.LR,'pink','lightgreen'))%>%
  formatPercentage('SharePortfolio', 1) %>%
  formatStyle('SharePortfolio', background = color_from_middle(t2$SharePortfolio,'lightblue','lightblue'))
```
<center>

# Porfolio Performance Index:

```{r include = TRUE, echo=FALSE, fig.align='center'}
textMain <- paste0(as.character(end(dm$logRetPort)),' Daily log return:' , round(tail(dm$logRetPort,1)*100,2),'% ',
       'Monthly log return:' , 
       round(sum(dm$logRetPort[paste0(Sys.Date()-30,'/',Sys.Date())])*100,2),'%')
close360d <- as.vector(window(dm$adjClosePort, start=Sys.Date()-364, end = Sys.Date())[1])

dygraphs::dygraph(dm$adjClosePort[paste0(Sys.Date()-360,'/',Sys.Date())]/ close360d, 
                  main =textMain)  %>%
  dyRangeSelector(height = 20)
```

# Cboe Volatility Index:
```{r include = TRUE, echo=FALSE, fig.align='center'}
dygraphs::dygraph(dp$vola$VIX[paste0(Sys.Date()-360,'/',Sys.Date())],  main = paste(unlist(strsplit(as.character(end(dp$vola$VIX))," ")),"VIX S&P 500 ",round(tail(dp$vola$VIX,1),4),"Pt. Change",round(diff(tail(dp$vola$VIX,2))[2],4))) %>%
  dyRangeSelector(height = 20)
```
</center>
